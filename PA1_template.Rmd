---

---
> ## Introduction
> 
> It is now possible to collect a large amount of data about personal
> movement using activity monitoring devices such as a
> [Fitbit](http://www.fitbit.com), [Nike
> Fuelband](http://www.nike.com/us/en_us/c/nikeplus-fuelband), or
> [Jawbone Up](https://jawbone.com/up). These type of devices are part of
> the "quantified self" movement -- a group of enthusiasts who take
> measurements about themselves regularly to improve their health, to
> find patterns in their behavior, or because they are tech geeks. But
> these data remain under-utilized both because the raw data are hard to
> obtain and there is a lack of statistical methods and software for
> processing and interpreting the data.
> This assignment makes use of data from a personal activity monitoring
> device. This device collects data at 5 minute intervals through out the
> day. The data consists of two months of data from an anonymous
> individual collected during the months of October and November, 2012
> and include the number of steps taken in 5 minute intervals each day.
> 
> ## Data
> 
> The data for this assignment can be downloaded from the course web
> site:
> * Dataset: [Activity monitoring data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip) [52K]
> The variables included in this dataset are:
> * **steps**: Number of steps taking in a 5-minute interval (missing
>     values are coded as `NA`)
> * **date**: The date on which the measurement was taken in YYYY-MM-DD
>     format
> * **interval**: Identifier for the 5-minute interval in which
>     measurement was taken
> The dataset is stored in a comma-separated-value (CSV) file and there
> are a total of 17,568 observations in this
> dataset.

Load packages.

```{r}
packages <- c("data.table", "ggplot2", "xtable", "VIM")
sapply(packages, require, character.only=TRUE, quietly=TRUE)
```

## Loading and preprocessing the data

Unzip the data file.

```{r}
executable <- file.path("C:", "Program Files", "WinRAR", "Rar.exe")
parameters <- "x"
f <- file.path(getwd(), "activity.zip")
switch <- "-aoa"
cmd <- paste(paste0("\"", executable, "\""), parameters, paste0("\"", f, "\""), switch)
cmd
system(cmd)
```

Read the CSV file.
Convert the data frame to a data table using the [`data.table`](http://cran.r-project.org/web/packages/data.table/index.html) package.

```{r}
dt <- read.csv(file.path(getwd(), "activity.csv"))
dt <- data.table(dt)
```
 
Verify that the number of rows in the dataset is the expected value of 17,568.

```{r}
check <- nrow(dt) == 17568
if (check == FALSE) stop("The number of rows in the dataset is not 17,568.")
```

Convert the `date` variable to a date class.
And look at the structure of the dataset.

```{r}
dt <- dt[, date := as.Date(date)]
setkey(dt, date, interval)
str(dt)
dt
```

## What is mean total number of steps taken per day?

Aggregate the number of steps taken each day.
Days with missing values (`NA`) will have `NA` when aggregated.

```{r}
dtDaily <- dt[, list(sumSteps = sum(steps)), date]
head(dtDaily)
```

Plot a histogram of the total number of steps taken each day.

```{r histogramStepsTakenEachDay}
ggplot(dtDaily, aes(x=sumSteps)) +
	geom_histogram(alpha=1/2, binwidth=1000)
```

Calculate the mean and median total number of steps taken per day **before imputing**.

```{r, results='asis'}
tab <- dtDaily[, list(n = .N, nValid = sum(!is.na(sumSteps)), mean = mean(sumSteps, na.rm=TRUE), median = median(sumSteps, na.rm=TRUE))]
print(xtable(tab), type="html", include.rownames=FALSE)
```

Copy the data table `dtDaily` before imputation to be used later.

```{r}
dtDaily <- dtDaily[, status := "Before imputation"]
dtDailyBeforeImputation <- dtDaily
```

## What is the average daily activity pattern?

Aggregate the average number of steps taken by 5-minute interval.

```{r}
dtIntervals <- dt[, list(meanSteps = mean(steps, na.rm=TRUE)), interval]
```

Plot a time series of the 5-minute interval and the average number of steps taken across all days.

```{r timeseriesStepsTakenEachInterval}
ggplot(dtIntervals, aes(x=interval, y=meanSteps)) +
	geom_line()
```

## Imputing missing values

Calculate the total number of missing values.

```{r, results='asis'}
dt <- dt[, isStepsMissing := is.na(steps)]
tab <- dt[, .N, isStepsMissing]
print(xtable(tab), type="html", include.rownames=FALSE)
```

Use the [VIM](http://cran.r-project.org/web/packages/VIM/index.html) package to impute missing values of the `steps` variable.
Use k-Nearest Neighbour Imputation.
I couldn't get Iterative robust model-based imputation (IRMI) to work; try again later.

```{r}
dt <- kNN(dt)
# dt <- irmi(dt)
```

The `kNN` function returns a dataset with all `NA`s replaced.
So the `steps` variable now contains imputed values replacing the `NA`s.

Verify that there are no missing values for `steps` after imputation.

```{r, results='asis'}
tab <- dt[, .N, list(isMissing = is.na(steps))]
print(xtable(tab), type="html", include.rownames=FALSE)
```

Verify that missingness is complete for an entire day.
Show all days with at least 1 missing value for the `steps` variable.
Calculate the proportion of records with missing values for each such day.
All proportions are 100%.

```{r}
dtMissingness <- dt[, list(countMissing = sum(isStepsMissing), countRecords = .N, propMissing = sum(isStepsMissing / .N)), date]
dtMissingness[countMissing > 0]
```

#### After imputation of missing values

Aggregate the number of steps taken each day.

```{r}
dtDaily <- dt[, list(sumSteps = sum(steps), isImputed = sum(steps_imp) > 0), date]
head(dtDaily)
```

Plot a histogram of the total number of steps taken each day **after imputing** and compare with the histogram **before imputing**.
Need to add an `isImputed` column to `dtDailyBeforeImputation` to make `rbind` work.

```{r histogramStepsTakenEachDayAfterImputation}
dtDaily <- dtDaily[, status := "After imputation"]
dtDailyBeforeImputation <- dtDailyBeforeImputation[, isImputed := FALSE]
dtDaily <- rbind(dtDaily, dtDailyBeforeImputation, use.names=TRUE)
ggplot(dtDaily, aes(x=sumSteps, fill=isImputed)) +
	geom_histogram(alpha=1/2, binwidth=1000) +
  facet_wrap(~ status, nrow=2) +
  theme(legend.position="bottom")
```

Calculate the mean and median total number of steps taken per day **after imputing**.

```{r, results='asis'}
tab <- dtDaily[, list(n = .N, nValid = sum(!is.na(sumSteps)), mean = mean(sumSteps, na.rm=TRUE), median = median(sumSteps, na.rm=TRUE)), status]
print(xtable(tab), type="html", include.rownames=FALSE)
```

The median of the imputed values is the same as the original values where missing values were not imputed.
However, the mean of the imputed values is **less than** the original values.
The overall impact of the imputed values is to **lower** the estimates of the number of steps taken each day.

## Are there differences in activity patterns between weekdays and weekends?

Create a new factor variable in the dataset with two levels -- "weekday" and "weekend" indicating whether a given date is a weekday or weekend day.
Use this solution to [collapse the factor values](http://stackoverflow.com/a/9053619) for day of week.
Verify that `dayOfWeek` and `dayType` are factor class variables.

```{r}
levels <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
newLevels <- c("Weekend", rep("Weekday", 5), "Weekend")
dt <- dt[, dayOfWeek := factor(weekdays(date), levels=levels)]
dt <- dt[, dayType := factor(newLevels[dayOfWeek])]
dt[, .N, list(dayType, dayOfWeek)]
message(sprintf("Is dayOfWeek a factor? %s. Is dayType a factor? %s", is.factor(dt$dayOfWeek), is.factor(dt$dayType)))
```

Aggregate the average number of steps taken by 5-minute interval.
Use the imputed values in the `steps` variable.

```{r}
dtIntervals <- dt[, list(meanSteps = mean(steps, na.rm=TRUE)), list(dayType, interval)]
```

Plot two time series (one for weekdays and the other for weekends) of the 5-minute intervals and average number of steps taken (imputed values).

```{r timeseriesStepsTakenEachIntervalByDayTypePanel}
ggplot(dtIntervals, aes(x=interval, y=meanSteps, color=dayType)) +
	geom_line() +
	facet_wrap(~ dayType, nrow=2) +
	theme(legend.position="none")
```

It's a bit hard to discern any differences.
So overlay the time series on a single plot instead of using a panel plot.

```{r timeseriesStepsTakenEachIntervalByDayType}
ggplot(dtIntervals, aes(x=interval, y=meanSteps, color=dayType)) +
	geom_line() +
	theme(legend.position="bottom")
```
